# AI-BOS RSC Boundary Constitution
# Version: 2.0.0
# Purpose: Governance rules for React Server Components (RSC), ensuring strict server/client boundaries, hydration safety, import tracing, server action safety, and MCP validation.
# Machine-Enforceable: All rules structured for MCP validation

$schema: "http://json-schema.org/draft-07/schema#"
title: "AI-BOS RSC Boundary Constitution"
version: "2.0.0"
description: "Governance rules for React Server Components (RSC), ensuring strict server/client boundaries, hydration safety, import tracing, server action safety, and MCP validation."

constitution:
  server:
    forbidden:
      browser_globals:
        - window
        - document
        - navigator
        - localStorage
        - sessionStorage
        - location
        - history
        - fetch # must use server fetch utilities
      hooks:
        - useEffect
        - useLayoutEffect
        - useState
        - useReducer
        - useRef
        - useCallback
        - useMemo
        - useContext
      imports:
        - "react-dom/client"
        - "react-dom/server"
        - "@radix-ui/react-*"
      patterns:
        - "onClick"
        - "onChange"
        - "className={dynamic}"
        - "style={{ color: ... }}"
        - "use client"
        - "ReactDOM.render"
        - "ReactDOM.hydrateRoot"
    required:
      - "All styling via CSS variables"
      - "All data fetching via async/await"
      - "All server actions validated"
      - "No hydration in RSC output"
      - "Server components must remain pure render functions"

  hydration_safety:
    forbidden:
      - "ReactDOM.render"
      - "ReactDOM.hydrateRoot"
      - "Any hydration in RSC"
    rules:
      - "No client-side rendering in RSC output"
      - "Interactive elements must be client components"
      - "Hydration must occur in client-only components"

  async_server_components:
    side_effect_guard:
      forbidden:
        - "logging to client sinks"
        - "side effects in render"
        - "mutable state writes"
        - "external calls without normalization"
      allowed:
        - "database reads"
        - "filesystem reads"
        - "server-only logging"
        - "async data fetching"
      rules:
        - "No client-visible side effects during render"
        - "Side effects must be server-only"
        - "Async components must remain pure"

  server_actions:
    input_validation:
      required: true
      schema_enforcement:
        - "All inputs must be validated by zod or similar"
        - "No raw object usage"
        - "No destructuring of unvalidated params"
      security:
        - "Prevent object injection"
        - "Sanitize all user input"
        - "All parameters must be typed"
    rules:
      - "Server actions must validate all inputs"
      - "No unvalidated parameters"
      - "Schemas required for all action inputs"

  client:
    required:
      directive: "'use client'"
      location: "first line"
    allowed:
      hooks:
        - useEffect
        - useLayoutEffect
        - useState
        - useReducer
        - useRef
        - useCallback
        - useMemo
        - useContext
      browser_apis:
        - window
        - document
        - navigator
        - localStorage
        - sessionStorage
        - location
        - history
      patterns:
        - "onClick"
        - "onChange"
        - "dynamic className"
        - "inline style"
    forbidden:
      - "Server-only imports"
      - "Server actions called directly in client components"

  radix_ui:
    clarification:
      - "Radix UI is client-only"
      - "No Radix imports allowed in RSC"
    rules:
      - "All @radix-ui/react-* imports must appear only in client components"
      - "RSC may not import or render Radix primitives"

  boundary_detection:
    server_indicators:
      - "absence of 'use client'"
      - "async component"
      - "database queries"
      - "file system reads"
      - "server actions"
    client_indicators:
      - "'use client' directive"
      - "React hooks"
      - "event handlers"
      - "browser APIs"
      - "Radix UI primitives"

  import_tracing:
    forbidden_transitive:
      - "imports that bring browser APIs into RSC transitively"
      - "imports that bring client hooks into RSC transitively"
      - "imports that bring Radix UI into RSC transitively"
    validation:
      - "Trace all imports recursively"
      - "Reject if browser API is found"
      - "Reject if client hook is found"
      - "Reject if Radix UI is found"

  styling:
    server_components:
      allowed:
        - "CSS variables via className"
        - "token-based Tailwind utilities"
        - "static classNames"
      forbidden:
        - "inline styles (dynamic)"
        - "style props with JavaScript values"
        - "dynamic Tailwind classes using arbitrary colors"
    client_components:
      allowed:
        - "dynamic styles"
        - "inline styles"
        - "token injection"
        - "CSS variable overrides"

  ai_generation:
    server_component_rules:
      required:
        - "No browser APIs"
        - "No client hooks"
        - "No Radix imports"
        - "CSS variables only"
        - "No hydration"
      forbidden:
        - "hex colors"
        - "inline CSS colors"
        - "raw pixels"
        - "arbitrary spacing"
    client_component_rules:
      required:
        - "use client at top"
        - "proper hook usage"
        - "ARIA attributes"
        - "keyboard navigation"
      forbidden:
        - "server-only imports"
        - "direct server action usage"
    validation_checks:
      - "Contrast >= 4.5:1"
      - "ARIA attributes exist"
      - "Keyboard navigation present"
      - "Boundary rules enforced"

  validation:
    static_analysis:
      - "'use client' directive detection"
      - "browser global detection"
      - "forbidden hooks detection"
      - "forbidden imports detection"
      - "import chain tracing"
      - "server action input validation"
      - "hydration detection"
      - "async side-effect detection"
    runtime_checks:
      - "Ensure RSC does not call client APIs"
      - "Ensure client components contain 'use client'"
      - "Ensure server actions validate inputs"
      - "Monitor for boundary violations"

  observability:
    boundary_violation_telemetry:
      event_schema:
        violation_type:
          - server_component_browser_api
          - server_component_client_hook
          - server_component_radix_import
          - server_component_hydration
          - client_component_missing_directive
          - server_action_validation_failure
          - async_component_side_effect
        required_fields:
          - component_path
          - violation_type
          - violation_details
          - timestamp
          - severity
          - stack_trace
        severity_levels:
          - critical
          - warning
          - info
      rules:
        - "All violations emit telemetry"
        - "Critical issues trigger alerts"
        - "Full context required for debugging"

  mcp_tools:
    - "mcp_react_validate_rsc_boundary"
    - "mcp_react_check_server_client_usage"
    - "mcp_react_validate_imports"
    - "mcp_react_validate_server_actions"
    - "mcp_react_check_hydration_safety"
    - "mcp_react_validate_async_side_effects"
