# AI-BOS Component Constitution
# Version: 2.1.0
# Purpose: Enforce component structure, API, and accessibility rules
# Aligned with: docs/01-foundation/ui-system/components-philosophy.md
# Machine-Enforceable: All rules structured for MCP validation

$schema: "http://json-schema.org/draft-07/schema#"
title: "AI-BOS Component Constitution"
version: "2.1.0"
description: "Component governance, API structure, accessibility, state rules, styling tokens, RSC boundaries, motion safety, and MCP validation."

constitution:
  structure:
    required:
      - "forwardRef for components that accept refs"
      - "displayName must be defined"
      - "Props must use TypeScript interfaces"
      - "Props must extend correct React.HTMLAttributes"
    patterns:
      primitive:
        - "No Radix UI dependencies"
        - "Built on tokens only"
        - "Server Component compatible unless interactive"
        - "Uses forwardRef"
        - "Simple props"
      composition:
        - "Built on Radix UI primitives"
        - "Client Component only"
        - "Full keyboard/ARIA handled by Radix"
        - "Includes multiple subcomponents"
        - "Supports portals, focus scopes"
      functional:
        - "Uses headless libraries (TanStack Table, Visx, React Flow)"
        - "Client Component only"
        - "Manual accessibility required"
        - "Data-driven rendering"
      layout:
        - "Combines primitives + compositions"
        - "Responsive"
        - "Client-side interactive"
        - "Full keyboard support"
    state_machines:
      required_for:
        - "datePicker"
        - "stepper"
        - "modal"
        - "drawer"
        - "menu with submenus"
        - "tabs with dynamic content"
        - "complex accordions"
      rules:
        - "Use XState or reducer patterns"
        - "Transitions must be explicit"
        - "Logic and UI must be separated"
        - "State must be testable"

  props:
    required:
      - "Props must extend matching React HTML attributes"
      - "All props must be typed"
      - "Optional props must have defaults"
      - "Required props must be explicit"
    forbidden:
      - "Untyped props"
      - "Props that override design tokens"
      - "Props that break accessibility"
    naming:
      - "Use semantic prop names: variant, size, state, intent"
      - "Avoid generic: data, options, props"
    union_types:
      required:
        - "Variant props must use discriminated unions"
      rules:
        - "All variant props must map to semantic tokens"
        - "All size props must map to spacing/typography tokens"
        - "State props must map to state tokens"
      examples:
        variant:
          - "solid → --color-accent"
          - "outline → --color-accent + border"
          - "ghost → --color-surface-muted"
        size:
          - "sm → spacingTokens.sm + typographyTokens.button"
          - "md → spacingTokens.md + typographyTokens.button"
          - "lg → spacingTokens.lg + typographyTokens.button"

  styling:
    allowed:
      - "componentTokens presets"
      - "Token-based Tailwind classes"
      - "CSS variables"
      - "layout classes only"
    forbidden:
      - "hex colors"
      - "tailwind palette colors"
      - "inline style colors"
      - "arbitrary pixels"
      - "raw font-size"
      - "raw z-index"
      - "raw opacity"
      - "tokens.ts import in RSC"
    rules:
      - "All styling must be done via tokens"
      - "Semantic tokens required when available"
      - "Density modes must be supported"
      - "Focus ring tokens must be used"
      - "State tokens must be used for hover/active/disabled"
    token_alias_mapping:
      variant:
        solid: "--color-accent"
        outline: "--color-accent"
        ghost: "--color-surface-muted"
      size:
        sm: "--space-button-sm"
        md: "--space-button-md"
        lg: "--space-button-lg"
      state:
        hover: "--color-accent-hover"
        active: "--color-accent-active"
        disabled: "--opacity-disabled"

  accessibility:
    keyboard:
      - "Tab key navigation required"
      - "Focus ring must be visible"
      - "Escape closes dialogs"
      - "Arrow keys required for menus/lists"
    aria:
      - "aria-label required for icon-only buttons"
      - "aria-describedby for inputs"
      - "aria-invalid for errors"
      - "aria-busy for loading"
    contrast:
      aa: "4.5:1 minimum"
      aaa: "7:1 minimum"
      rules:
        - "Safe mode enforces AAA"
        - "WCAG AA/AAA themes override tenant colors"
    focus:
      - "Focus trapped in modals"
      - "Focus restored on close"
      - "Tokens: --focus-ring-color, --focus-ring-width"
    touchTargets:
      - "Minimum 44px x 44px"
      - "Smallest padding allowed: 12px AA, 14px AAA"
    typography:
      aa:
        - "14px body min"
        - "12px captions allowed"
      aaa:
        - "18px body or 14px bold"
        - "14px captions minimum"
        - "Line-height 1.6"

  motion:
    animation_budget:
      limits:
        fast: "150ms"
        normal: "200ms"
        slow: "300ms"
        max_component_duration: "500ms"
        max_complex_duration: "1000ms"
        concurrent_animations: 2
    rules:
      - "All durations must use motion tokens"
      - "All easings must use token easings"
      - "Animations must respect reduced motion"
      - "No raw durations"
      - "No raw cubic-bezier"
    reduced_motion:
      - "Non-essential animations disabled"
      - "Essential animations remain"
      - "@media (prefers-reduced-motion) must be implemented"
    async_animation_guardrails:
      required:
        - "Use requestAnimationFrame"
        - "Use transform instead of layout properties"
      forbidden:
        - "Animating top/left/width/height"
        - "Blocking animations"
        - "Animations without will-change"

  hooks:
    server_components:
      forbidden:
        - "useEffect"
        - "useLayoutEffect"
        - "useState"
        - "useCallback"
        - "useMemo"
    client_components:
      allowed:
        - "All React hooks"
      rules:
        - "Hooks must be top-level"
        - "No conditional hooks"
    custom_hooks:
      naming:
        - "Must start with `use`"
      documentation:
        required:
          - "JSDoc required"
          - "@param and @returns required"
          - "@example required"

  imports:
    allowed:
      - "@aibos/ui"
      - "@aibos/ui/design/tokens (client only)"
      - "react"
      - "react-dom (client only)"
      - "radix primitives (client only)"
    forbidden:
      - "tokens.ts in server components"
      - "browser APIs in RSC"
      - "raw color imports"
    server_component_rules:
      - "All styling must use CSS variables"
      - "No token imports in RSC"
      - "client-only logic forbidden"

  safe_mode:
    required:
      - "Components must work with [data-safe-mode='true']"
      - "No shadows"
      - "No animations"
      - "Radius = 0"
      - "Font weight >= 500"
      - "Line-height >= 1.625"
      - "Minimum caption = 14px"
    atomic_application:
      rules:
        - "Safe mode applied atomically"
        - "No FOUC allowed"
        - "Use style tag swap"

  visual_regression:
    required:
      - "Snapshot baseline for all components"
      - "Snapshot of all variants"
      - "Snapshot of safe mode"
      - "Snapshot of reduced motion"
    mcp_tools:
      - "mcp_visual_regression_capture"
      - "mcp_visual_regression_compare"
      - "mcp_visual_regression_approve"
    auto_rollback:
      rules:
        - "Rollback on unacceptable deviation"
        - "Threshold defined per component"

  validation:
    required:
      - "Component structure validation"
      - "Props validation"
      - "Accessibility validation"
      - "Token usage validation"
      - "RSC boundary validation"
      - "Safe mode validation"
      - "State machine validation"
      - "Motion safety validation"
      - "Visual regression validation"
    mcp_tools:
      - "mcp_react_validate_component"
      - "mcp_react_validate_rsc_boundary"
      - "mcp_theme_validate_tokens"
      - "mcp_tailwind_validate_token_exists"
      - "mcp_a11y_validate_component"
      - "mcp_state_machine_validate"
      - "mcp_motion_validate_animations"
      - "mcp_visual_regression_compare"
